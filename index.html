<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="cache-control" content="max-age=0" />
		<meta http-equiv="cache-control" content="no-cache" />
		<meta http-equiv="expires" content="0" />
		<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
		<meta http-equiv="pragma" content="no-cache" />
		
		<title>Connect SDK Test App</title>
		<link rel="stylesheet" href="css/font-awesome.css" />
		<script src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js" language="JavaScript" type="text/javascript"></script>
		<style>
			html, body {
			    margin: 0;
			    padding: 0;
			    border: 0;
			    font-family: 'FontAwesome';
			}

			body {
				background-color: black;
			}

			.media {
				display: none;
				position: absolute;
				top: 0;
				bottom: 0;
				width: 100%;
				height: 100%;
				background-color: black;
			}

			#image {
				background-position: center center;
				background-repeat: no-repeat;
				background-size: contain;
			}

			#textContainer {
				position: absolute;
				display: none;
				width: 100%;
				height: 120px;
				bottom: 0;
				background-color: black;
				opacity: 50%;
				text-align: center;
			}

			#textMessage {
				display: table-cell;
				vertical-align: middle;
				color: white;
				font-size: 30pt;
			}

			#splash {
				position: absolute;
				display: table;
				width: 100%;
				height: 100%;
				text-align: center;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: gray;
			}

			#splash .fa-smile-o {
				display: table-cell;
				vertical-align: middle;
				color: white;
				font-size: 200pt;
			}

			#playControls {
				position: absolute;
				display: none;
				width: 100%;
				height: 120px;
				bottom: 0;
				background-color: black;
				opacity: 50%;
				text-align: center;
			}

			.playControl {
				display: table-cell;
				vertical-align: middle;
				color: white;
				font-size: 40pt;
			}

			#pauseButton {
				display: none;
			}

			#playBar {
				position: absolute;
				display: none;
				left: 0px;
				bottom: 120px;
				width: 100%;
				height: 5px;
				background-color: red;
			}

			#playBarProgress {
				width: 0px;
				height: 5px;
				background-color: orange;
			}
		</style>
	</head>
	<body>
		<div id="splash"><i class="fa fa-smile-o"></i></div>

		<video id="video" class="media" autoplay="autoplay"></video>
		<audio id="audio"></audio>
		<div id="image" class="media"></div>

		<div id="textContainer">
			<div id="textMessage">App is loading...</div>
		</div>

		<div id="playBar">
			<div id="playBarProgress"></div>
		</div>

		<div id="playControls">
			<div id="currentTime" class="playControl">00:00</div>
			<i id="playButton" class="fa fa-play playControl"></i>
			<i id="pauseButton" class="fa fa-pause playControl"></i>
			<div id="totalTime" class="playControl">00:00</div>
		</div>

		<script src="connectsdk.js" language="JavaScript" type="text/javascript"></script>
		<script language="JavaScript" type="text/javascript">
			String.prototype.toHHMMSS = function () {
			    var sec_num = parseInt(this, 10); // don't forget the second param
			    var hours   = Math.floor(sec_num / 3600);
			    var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
			    var seconds = sec_num - (hours * 3600) - (minutes * 60);

			    if (hours   < 10) {hours   = "0"+hours;}
			    if (minutes < 10) {minutes = "0"+minutes;}
			    if (seconds < 10) {seconds = "0"+seconds;}
			    var time;

			    if (hours > 0)
			        time = hours+':'+minutes+':'+seconds;
			    else
			    	time = minutes + ':' + seconds;

			    return time;
			}

			window.onload = function(evt) {
				var videoElement = document.getElementById('video');
				videoElement.autoplay = true;

				window.connectManager = new connectsdk.ConnectManager();
				window.connectManager.setMediaElement(videoElement);

				var textContainer = document.getElementById('textContainer');
				var textElement = document.getElementById('textMessage');

				window.connectManager.on('ready', function(evt) {
					textElement.innerText = "Ready to receive messages";
				});

				window.connectManager.on('message', function(message) {
					var messageString;

					if (typeof message == "string")
						messageString = message;
					else if (typeof message == "object")
						messageString = JSON.stringify(message);

					textContainer.style.display = 'table';
					textElement.innerText = messageString;

					window.connectManager.sendMessage("I got your message :-)");
				});

				var cleanupVideo = function() {
					if (videoElement.playbackRate != 0)
						videoElement.pause();

					document.getElementById('currentTime').innerText = 
						document.getElementById('totalTime').innerText = "00:00";

					videoElement.style.display = 'none';

					document.getElementById('playBar').style.display = 'none';
					document.getElementById('playControls').style.display = 'none';
				};

				var cleanupImage = function() {
					document.getElementById('image').style.backgroundImage = '';
					document.getElementById('image').style.display = 'none';
				};

				var cleanupMedia = function() {
					cleanupVideo();
					cleanupImage();
				};

				window.connectManager.on('image', function(imageInfo) {
					cleanupMedia();

					document.getElementById('image').style.backgroundImage = 'url(' + imageInfo.src + ')';
					document.getElementById('image').style.display = 'table';
					document.getElementById('splash').style.display = 'none';
				});

				videoElement.addEventListener('loadstart', function() {
					cleanupMedia();

					videoElement.style.display = 'table';
					videoElement.play();

					document.getElementById('playBar').style.display = 'block';
					document.getElementById('playControls').style.display = 'table';
					document.getElementById('splash').style.display = 'none';
				});

				videoElement.addEventListener('play', function() {
					document.getElementById('playButton').style.display = 'none';
					document.getElementById('pauseButton').style.display = 'table-cell';
				});

				videoElement.addEventListener('pause', function() {
					document.getElementById('pauseButton').style.display = 'none';
					document.getElementById('playButton').style.display = 'table-cell';
				});

				videoElement.addEventListener('timeupdate', function() {
					var progress = videoElement.currentTime / videoElement.duration;
					var progressString = "" + (progress * 100);
					var currentTimeString = "" + videoElement.currentTime;
					var durationString = "" + videoElement.duration;

					document.getElementById('playBarProgress').style.width = progressString + "%";
					document.getElementById('currentTime').innerText = currentTimeString.toHHMMSS();
					document.getElementById('totalTime').innerText = durationString.toHHMMSS();
				});

				videoElement.addEventListener('ended', function() {
					cleanupMedia();

					document.getElementById('splash').style.display = 'table';
				});

				window.connectManager.on('stop', function() {
					cleanupMedia();

					document.getElementById('splash').style.display = 'table';

                    window.close();
				});

				window.connectManager.init();
			};
		</script>
	</body>
</html>