//
//  Connect SDK JavaScript Bridge
//
//  Created by Jeremy White on 12/2/13.
//  Copyright (c) 2014 LG Electronics.
//
//  Licensed under the Apache License, Version 2.0 (the "License");
//  you may not use this file except in compliance with the License.
//  You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
//  Unless required by applicable law or agreed to in writing, software
//  distributed under the License is distributed on an "AS IS" BASIS,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//  See the License for the specific language governing permissions and
//  limitations under the License.
//
var connectsdk=function(){function e(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=RegExp("[\\?&]"+e+"=([^&#]*)"),n=t.exec(location.search);return null==n?"":decodeURIComponent(n[1].replace(/\+/g," "))}function t(e){var t;if(!e.constructor)throw t=function(){},Error("no constructor");t=e.constructor,delete e.constructor;var a=t.prototype;return e.mixins&&(e.mixins.forEach(function(e){n(a,e)}),delete e.mixins),e.statics&&(n(t,e.statics),delete e.statics),n(a,e),t}function n(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function a(){}var i={addListener:function(e,t,n){if(!e)throw Error("missing parameter: event");if(!t)throw Error("missing parameter: callback");return this._listeners=this._listeners||{},this._listeners||(this._listeners={}),this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push({callback:t,context:n}),this.emit("_addListener",e),this},removeListener:function(e,t,n){return this._listeners&&this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter(function(e){return t&&t!==e.callback&&n&&n!==e.context})),this.emit("_removeListener",e),this},hasListeners:function(e){if(e)return this._listeners&&this._listeners[e]&&this._listeners[e].length>0;for(e in this._listeners)if("_"!==e[0]&&this._listeners.hasOwnProperty(e)&&this._listeners[e].length>0)return!0;return!1},emit:function(e){var t=this._listeners&&this._listeners[e],n=Array.prototype.slice.call(arguments,1);this["on"+e]&&this["on"+e].apply(this,n),t&&t.forEach(function(e){e.callback.apply(e.context||null,n)})},on:function(e,t,n){return this.addListener(e,t,n)},off:function(e,t,n){return this.removeListener(e,t,n)}},s=t({mixins:[i],statics:{PlatformType:{DEFAULT:"Default",GOOGLE_CAST:"GoogleCast",WEBOS_NATIVE:"WebOSNative",WEBOS_WEB_APP:"WebOSWebApp"},EventType:{PLAY:"play",PAUSE:"pause",STOP:"stop",MESSAGE:"message"}},mediaEvents:{loadstart:"buffering",playing:"playing",waiting:"buffering",ended:"finished",play:"playing",pause:"paused"},constructor:function(){n(this,o[this._detectPlatform()])},setMediaElement:function(e){this.mediaElement&&this.unregisterMediaEvents(this.mediaElement),e&&(this.registerMediaEvents(e),this.mediaElement=e,this.mediaElement.autoPlay=!0,this.emit("mediaElementUpdate",e),this.setMediaStatus("idle"))},setImageElement:function(e){e&&(this.imageElement=e,this.emit("imageElementUpdate",e))},registerMediaEvents:function(e){if(e)for(var t in this.mediaEvents)this.mediaEvents.hasOwnProperty(t)&&e.addEventListener(t,this.handleMediaEvent.bind(this))},unregisterMediaEvents:function(e){if(e)for(var t in this.mediaEvents)this.mediaEvents.hasOwnProperty(t)&&e.removeEventListener(t,this.handleMediaEvent,this)},handleMediaEvent:function(e){this.mediaEvents.hasOwnProperty(e.type)&&this.setMediaStatus(this.mediaEvents[e.type])},setMediaStatus:function(e){this.mediaStatus=e,this.emit("mediaStatusUpdate",e)},_detectPlatform:function(){var e=navigator.userAgent.toLowerCase();return this.platformType=s.PlatformType.DEFAULT,e.indexOf("crkey")>0&&null!=cast?this.platformType=s.PlatformType.GOOGLE_CAST:e.indexOf("tv")>=0&&e.indexOf("webos")>=0&&(this.platformType=window.PalmServiceBridge?s.PlatformType.WEBOS_NATIVE:s.PlatformType.WEBOS_WEB_APP),this.platformType},init:a,sendMessage:a}),o={};o.Default={interactive:!1,init:a,sendMessage:a};var r={interactive:!0,init:function(){window.addEventListener("keydown",this.onKeyDown.bind(this)),this.webOSAppChannels=new c,this.webOSAppChannels.connectManager=this,this.webOSAppChannels.on("message",this.onMessage.bind(this)),this.webOSAppChannels.on("ready",this.onReady.bind(this)),this.webOSAppChannels.start(),this.loadMediaFromURI()},loadMediaFromURI:function(){var t={url:e("target"),mimeType:e("mimeType"),title:e("title"),description:e("description"),iconSrc:e("iconSrc"),loop:"true"===e("shouldLoop")};if(t.url&&t.mimeType){var n=t.mimeType.split("/")[0];n&&(console.log("Attempting to load",n),this.mediaElement&&this.mediaElement.tagName.toLowerCase()===n?this.loadMedia({src:t.url}):console.log("Failed to load: Media type mismatch."))}},onLoadMedia:function(e){var t=this.mediaElement;t&&e&&e.mediaURL?(console.log("Loading",e.mediaURL),t.src=e.mediaURL,t.load()):console.log("Failed to load media")},onLoadImage:function(e){var t=this.imageElement;t&&e&&e.mediaURL?(console.log("Loading image",e.mediaURL),t.src=e.mediaURL):console.log("Failed to load image")},onKeyDown:function(e){if(this.mediaElement)switch(e.keyCode){case 415:console.log(this.name+" :: play command received"),this.mediaElement.play(),this.emit(s.EventType.PLAY);break;case 19:console.log(this.name+" :: pause command received"),this.mediaElement.pause(),this.emit(s.EventType.PAUSE);break;case 413:console.log(this.name+" :: stop command received"),this.emit(s.EventType.STOP)}},onReady:function(){this.emit("ready")},onMessage:function(e){this.emit("message",e)},sendMessage:function(e){this.webOSAppChannels.sendMessage(e)}};o.WebOSNative=n({name:"webOS Native Web App"},r),o.WebOSWebApp=n({name:"webOS Web App"},r),o.GoogleCast={name:"Google Cast",interactive:!1,init:function(){this.mediaElement&&(window.castMediaManager=new cast.receiver.MediaManager(this.mediaElement)),this.on("mediaElementUpdate",this.onMediaElementUpdate,this),window.castReceiverManager=cast.receiver.CastReceiverManager.getInstance(),window.castMessageBus=window.castReceiverManager.getCastMessageBus("urn:x-cast:com.connectsdk"),window.castMessageBus.addEventListener("message",this.onMessage.bind(this)),window.castReceiverManager.addEventListener("ready",this.onReady.bind(this)),window.castReceiverManager.start()},onMediaElementUpdate:function(e){e&&(window.castMediaManager?window.castMediaManager.setMediaElement(e):window.castMediaManager=new cast.receiver.MediaManager(e))},onReady:function(){this.emit("ready")},onMessage:function(e){var t;try{t=JSON.parse(e.data)}catch(n){t=e.data}this.emit("message",t)},sendMessage:function(e){var t;if("string"==typeof e)window.castMessageBus.broadcast(e);else{var t=JSON.stringify(e);t&&window.castMessageBus.broadcast(t)}}};var d,c=t({mixins:[i],constructor:function(){function e(e,t,n){var a=new window.PalmServiceBridge;return a.onservicecallback=function(e){n(JSON.parse(e))},a.call(e,JSON.stringify(t||{})),a}function t(e){for(var t,n=e.split("&"),a={},i=0,s=n.length;s>i;i++)t=n[i].split("="),a[t[0]]=decodeURIComponent(t[1]);return a}if(d)return d;if(d=this,this.stopRequested=!1,this.ws=null,this.channels=[],window.PalmServiceBridge){var n,a="com.webos.service.secondscreen.gateway",i="luna://com.webos.service.secondscreen.gateway/app2app/createAppChannel",s="luna://com.palm.bus/signal/registerServerStatus";this.getAppChannelWebSocket=function(t){statusSubcription=e(s,{subscribe:!0,serviceName:a},function(a){a&&a.connected&&(n=e(i,{},function(e){e.socketUrl&&t(new WebSocket(e.socketUrl))}))})}}else if(window.location.search){console.log("found params: ",window.location.search);var o=t(window.location.search.substr(1));o.webOSAppChannelSocketUrl&&(console.log("found websocket URL: ",o.webOSAppChannelSocketUrl),this.getAppChannelWebSocket=function(e){e(new WebSocket(o.webOSAppChannelSocketUrl))})}},getAppChannelWebSocket:function(){console.error("app channel socket not supported")},sendMessage:function(e){var t={type:"p2p",payload:e};this._send(t)},_send:function(e){this.ws&&e&&(console.log("sending message: ",e),this.ws.send(JSON.stringify(e)))},_destroy:function(){this.ws&&(this.ws=null)},start:function(){this.stopRequested=!1;var e=this;!this.ws&&this.getAppChannelWebSocket(function(t){return e.stopRequested?(e.stop(),void 0):(e.ws=t,e.ws.onopen=function(t){console.log("websocket opened"),e.connectManager.on("mediaStatusUpdate",e._handleMediaStatusUpdate,e),e.emit("ready",t)},e.ws.onerror=function(e){console.log("websocket error:",e)},e.ws.onmessage=function(t){try{var n=JSON.parse(t.data)}catch(a){}console.log("got message: "+JSON.stringify(n)),"p2p"===n.type?e._handleP2PMessage(n):"p2p.join-request"===n.type?e._handleP2PJoinRequest(n):"p2p.join"===n.type?e._handleP2PJoin(n):"p2p.depart"===n.type&&e._handleP2PDepart(n)},e.ws.onclose=function(){e.connectManager.off("mediaStatusUpdate",e._handleMediaStatusUpdate,e),e.ws=null},void 0)})},stop:function(){this.stopRequested=!0,this.ws&&this.ws.close(),this._destroy()},_handleMediaStatusUpdate:function(e){var t=this.connectManager.mediaStatus,n=0,a=0,i=this.connectManager.mediaElement;if(i){if(n=i.currentTime,0/0!=i.duration&&(a=i.duration),null==t)return;this.sendMessage({contentType:"connectsdk.mediaEvent",mediaEvent:{type:"playState",playState:t,position:n,duration:a,requestId:e?e:-1}})}},_handleP2PMessage:function(e){var t=e.payload;if(t){console.log("processing message payload "+JSON.stringify(t));var n=e.payload.contentType;"connectsdk.mediaCommand"===n?this._handleMediaCommand(e):this.emit("message",e.payload)}},_handleP2PJoinRequest:function(e){var t=e.payload;t&&this._send({type:"p2p.join-response",payload:{allowJoin:!0,requestId:t.requestId}})},_handleP2PJoin:function(e){var t=e.payload;t&&this.emit("join",{client:t.client})},_handleP2PDepart:function(e){var t=e.payload;t&&this.emit("depart",{client:t.client})},_handleMediaCommand:function(e){var t=e.payload.mediaCommand;if(t){var n=t.type;console.log("processing mediaCommand "+JSON.stringify(t)+" of type "+n),"seek"===n?this._handleSeekCommand(e):"getPosition"===n?this._handleGetPosition(e):"getDuration"===n?this._handleGetDuration(e):"playMedia"===n?this._handlePlayMedia(e):"displayImage"===n&&this._handleDisplayImage(e)}},_handleSeekCommand:function(e){var t=e.payload.mediaCommand.position;if(t){var n=e.payload.mediaCommand.requestId,a=this.connectManager.mediaElement;a.currentTime=t,this._handleMediaStatusUpdate(n)}},_handleGetDuration:function(e){var t=e.from,n=e.payload.mediaCommand.type,a=e.payload.mediaCommand.requestId,i=this.connectManager.mediaElement,s=i&&i.duration||0;this._send({type:"p2p",to:t,payload:{contentType:"connectsdk.mediaCommandResponse",mediaCommandResponse:{type:n,duration:s,requestId:a}}})},_handleGetPosition:function(e){var t=e.from,n=e.payload.mediaCommand.type,a=e.payload.mediaCommand.requestId,i=this.connectManager.mediaElement,s=i&&i.currentTime||0;this._send({type:"p2p",to:t,payload:{contentType:"connectsdk.mediaCommandResponse",mediaCommandResponse:{type:n,position:s,requestId:a}}})},_handlePlayMedia:function(e){var t=e.from,n=e.payload.mediaCommand,a=n.type,i=n.requestId;this.connectManager.emit("LoadMedia",n),this._send({type:"p2p",to:t,payload:{contentType:"connectsdk.mediaCommandResponse",mediaCommandResponse:{type:a,requestId:i}}})},_handleDisplayImage:function(e){var t=e.from,n=e.payload.mediaCommand,a=n.type,i=n.requestId;this.connectManager.emit("LoadImage",n),this._send({type:"p2p",to:t,payload:{contentType:"connectsdk.mediaCommandResponse",mediaCommandResponse:{type:a,requestId:i}}})}});return{ConnectManager:s,WebOSAppChannels:c}}();