//
//  Connect SDK JavaScript Bridge
//  Version 1.3.1 Date: 11 Jun 2014 2:22 PM
//
//  Created by Jeremy White on 4/16/14.
//  Copyright (c) 2014 LG Electronics.
//
//  Licensed under the Apache License, Version 2.0 (the "License");
//  you may not use this file except in compliance with the License.
//  You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
//  Unless required by applicable law or agreed to in writing, software
//  distributed under the License is distributed on an "AS IS" BASIS,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//  See the License for the specific language governing permissions and
//  limitations under the License.
//
var connectsdk=function(){function e(e){var n;if(!e.constructor)throw n=function(){},Error("no constructor");n=e.constructor,delete e.constructor;var s=n.prototype;return e.mixins&&(e.mixins.forEach(function(e){t(s,e)}),delete e.mixins),e.statics&&(t(n,e.statics),delete e.statics),t(s,e),n}function t(e,t){for(var n in t)t.hasOwnProperty(n)&&!e.hasOwnProperty(n)&&(e[n]=t[n]);return e}function n(){}var s={addListener:function(e,t,n){if(!e)throw Error("missing parameter: event");if(!t)throw Error("missing parameter: callback");return this._listeners=this._listeners||{},this._listeners||(this._listeners={}),this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push({callback:t,context:n}),this.emit("_addListener",e),this},removeListener:function(e,t,n){return this._listeners&&this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter(function(e){return t&&t!==e.callback&&n&&n!==e.context})),this.emit("_removeListener",e),this},hasListeners:function(e){if(e)return this._listeners&&this._listeners[e]&&this._listeners[e].length>0;for(e in this._listeners)if("_"!==e[0]&&this._listeners.hasOwnProperty(e)&&this._listeners[e].length>0)return!0;return!1},emit:function(e){var t=this._listeners&&this._listeners[e],n=Array.prototype.slice.call(arguments,1);e=e.charAt(0).toUpperCase()+e.slice(1),this["on"+e]&&this["on"+e].apply(this,n),t&&t.forEach(function(e){e.callback.apply(e.context||null,n)})},on:function(e,t,n){return this.addListener(e,t,n)},off:function(e,t,n){return this.removeListener(e,t,n)}},a=e({mixins:[s],statics:{PlatformType:{DEFAULT:"Default",AIRPLAY:"AirPlay",GOOGLE_CAST:"GoogleCast",WEBOS_NATIVE:"WebOSNative",WEBOS_WEB_APP:"WebOSWebApp"},EventType:{MESSAGE:"message",PAUSE:"pause",PLAY:"play",READY:"ready",STOP:"stop",STATUS:"mediaStatusUpdate",JOIN:"join",DEPART:"depart"}},mediaEvents:{loadstart:"buffering",playing:"playing",waiting:"buffering",abort:"finished",ended:"finished",play:"playing",pause:"paused"},constructor:function(){this.handleMediaEvent=this.handleMediaEvent.bind(this),t(this,i[this._detectPlatform()])},setImageElement:function(e){e&&(this.imageElement=e)},setMediaElement:function(e){this.mediaElement&&this.unregisterMediaEvents(this.mediaElement),e&&(this.registerMediaEvents(e),this.mediaElement=e,this.mediaElement.autoPlay=!0,this.setMediaStatus("idle"))},setMediaStatus:function(e){this.mediaStatus=e,this.emit(a.EventType.STATUS,e)},registerMediaEvents:function(e){if(e)for(var t in this.mediaEvents)this.mediaEvents.hasOwnProperty(t)&&e.addEventListener(t,this.handleMediaEvent,!1)},unregisterMediaEvents:function(e){if(e)for(var t in this.mediaEvents)this.mediaEvents.hasOwnProperty(t)&&e.removeEventListener(t,this.handleMediaEvent,!1)},handleMediaEvent:function(e){this.mediaEvents.hasOwnProperty(e.type)&&this.setMediaStatus(this.mediaEvents[e.type])},handleReady:function(){this.emit(a.EventType.READY)},handleJoin:function(e){this.emit(a.EventType.JOIN,e)},handleDepart:function(e){this.emit(a.EventType.DEPART,e)},_detectPlatform:function(){var e=navigator.userAgent.toLowerCase();return this.platformType=a.PlatformType.DEFAULT,/(iPad|iPhone|iPod)/g.test(navigator.userAgent)?this.platformType=a.PlatformType.AIRPLAY:e.indexOf("crkey")>0&&null!=cast?this.platformType=a.PlatformType.GOOGLE_CAST:(e.indexOf("tv")>=0&&e.indexOf("webos")>=0||e.indexOf("web0s")>=0)&&(this.platformType=window.PalmServiceBridge?a.PlatformType.WEBOS_NATIVE:a.PlatformType.WEBOS_WEB_APP),this.platformType},init:n,sendMessage:n,broadcastMessage:n}),i={};i.Default={interactive:!1,init:n,sendMessage:n,broadcastMessage:n};var o={onLoadImage:function(e){var t=this.imageElement;t&&e&&e.mediaURL?(console.log("Loading image",e.mediaURL),t.src=e.mediaURL):console.log("Failed to load image")},onLoadMedia:function(e){var t=this.mediaElement;t&&e&&e.mediaURL?(console.log("Loading",e.mediaURL),t.src=e.mediaURL,t.load()):console.log("Failed to load media")},handleDisplayImage:function(e){var t=e.from,n=e.message.mediaCommand,s=n.type,a=n.requestId;this.emit("loadImage",n),this.sendMessage(t,{contentType:"connectsdk.mediaCommandResponse",mediaCommandResponse:{type:s,requestId:a}})},handleGetDuration:function(e){var t=e.from,n=e.message.mediaCommand.type,s=e.message.mediaCommand.requestId,a=this.mediaElement,i=a&&a.duration||0;this.sendMessage(t,{contentType:"connectsdk.mediaCommandResponse",mediaCommandResponse:{type:n,duration:i,requestId:s}})},handleGetPosition:function(e){var t=e.from,n=e.message.mediaCommand.type,s=e.message.mediaCommand.requestId,a=this.mediaElement,i=a&&a.currentTime||0;this.sendMessage(t,{contentType:"connectsdk.mediaCommandResponse",mediaCommandResponse:{type:n,position:i,requestId:s}})},handleMediaStatusUpdate:function(e){var t=this.mediaStatus,n=0,s=0,a=this.mediaElement;if(a){if(n=a.currentTime,0/0!=a.duration&&(s=a.duration),null==t)return;this.broadcastMessage({contentType:"connectsdk.mediaEvent",mediaEvent:{type:"playState",playState:t,position:n,duration:s,requestId:e?e:-1}})}},handlePlayMedia:function(e){var t=e.from,n=e.message.mediaCommand,s=n.type,a=n.requestId;this.emit("loadMedia",n),this.sendMessage(t,{contentType:"connectsdk.mediaCommandResponse",mediaCommandResponse:{type:s,requestId:a}})},handleSeek:function(e){var t=e.from,n=e.message.mediaCommand,s=n.type,a=n.requestId,i=n.position;if(i){var o=this.mediaElement;o&&(o.currentTime=i),this.handleMediaStatusUpdate(-1)}this.sendMessage(t,{contentType:"connectsdk.mediaCommandResponse",mediaCommandResponse:{type:s,requestId:a}})},handlePlay:function(e){var t=e.from,n=e.message.mediaCommand,s=n.type,a=n.requestId,i=this.mediaElement;i&&i.play(),this.sendMessage(t,{contentType:"connectsdk.mediaCommandResponse",mediaCommandResponse:{type:s,requestId:a}})},handlePause:function(e){var t=e.from,n=e.message.mediaCommand,s=n.type,a=n.requestId,i=this.mediaElement;i&&i.pause(),this.sendMessage(t,{contentType:"connectsdk.mediaCommandResponse",mediaCommandResponse:{type:s,requestId:a}})},handleMessage:function(e){var t=null;if(null!=e&&null!=e.message&&(t=e.message.contentType,null==t))try{t=JSON.parse(e.message).contentType}catch(n){}switch(t){case"connectsdk.mediaCommand":this.handleMediaCommand(e);break;case"connectsdk.serviceCommand":this.handleServiceCommand(e);break;default:this.emit(a.EventType.MESSAGE,e)}},handleMediaCommand:function(e){var t=e.message.mediaCommand;if(t){var n=t.type;switch(console.log("processing mediaCommand "+JSON.stringify(t)+" of type "+n),n){case"displayImage":this.handleDisplayImage(e);break;case"getDuration":this.handleGetDuration(e);break;case"getPosition":this.handleGetPosition(e);break;case"playMedia":this.handlePlayMedia(e);break;case"seek":this.handleSeek(e);break;case"play":this.handlePlay(e);break;case"pause":this.handlePause(e)}}},handleServiceCommand:function(e){var t=e.message.serviceCommand;if(t){var n=t.type;switch(console.log("processing serviceCommand "+JSON.stringify(t)+" of type "+n),n){case"close":var s=window.open(window.location,"_self");null!=s?s.close():window.close()}}}},r=t({interactive:!0,init:function(){window.addEventListener("keydown",this.handleKeyDown.bind(this)),this.on(a.EventType.STATUS,this.handleMediaStatusUpdate.bind(this)),this.webOSAppChannels=new c,this.webOSAppChannels.on("message",this.handleMessage.bind(this)),this.webOSAppChannels.on("ready",this.handleReady.bind(this)),this.webOSAppChannels.on("join",this.handleJoin.bind(this)),this.webOSAppChannels.on("depart",this.handleDepart.bind(this)),this.webOSAppChannels.start()},sendMessage:function(e,t){this.webOSAppChannels.sendMessage(e,t)},broadcastMessage:function(e){this.webOSAppChannels.broadcastMessage(e)},handleKeyDown:function(e){if(this.mediaElement)switch(e.keyCode){case 415:console.log(this.name+" :: play command received"),this.mediaElement.play(),this.emit(a.EventType.PLAY);break;case 19:console.log(this.name+" :: pause command received"),this.mediaElement.pause(),this.emit(a.EventType.PAUSE);break;case 413:console.log(this.name+" :: stop command received"),this.emit(a.EventType.STOP)}}},o);i.WebOSNative=t({name:"webOS Native Web App"},r),i.WebOSWebApp=t({name:"webOS Web App"},r),i.AirPlay=t({name:"AirPlay",interactive:!0,init:function(){this.on(a.EventType.STATUS,this.handleMediaStatusUpdate.bind(this))},sendMessage:function(e,t){this.broadcastMessage(t)},broadcastMessage:function(e){var t;t="string"==typeof e?e:JSON.stringify(e);var n=document.createElement("IFRAME");n.setAttribute("src","connectsdk://"+t),document.documentElement.appendChild(n),n.parentNode.removeChild(n),n=null}},o),i.GoogleCast={name:"Google Cast",interactive:!1,init:function(){var e=this.setMediaElement;this.setMediaElement=function(t){e.apply(this,arguments),this._setCastElement(t)},this._setCastElement(this.mediaElement),window.castReceiverManager=cast.receiver.CastReceiverManager.getInstance(),window.castReceiverManager.addEventListener("ready",this._handleReady.bind(this)),window.castMessageBus=window.castReceiverManager.getCastMessageBus("urn:x-cast:com.connectsdk"),window.castMessageBus.addEventListener("message",this.handleMessage.bind(this)),window.castReceiverManager.start()},_handleReady:function(e){window.castReceiverManager.addEventListener(cast.receiver.CastReceiverManager.EventType.SENDER_CONNECTED,this.handleSenderConnected.bind(this)),window.castReceiverManager.addEventListener(cast.receiver.CastReceiverManager.EventType.SENDER_DISCONNECTED,this.handleSenderDisconnected.bind(this)),this.handleReady(e)},_setCastElement:function(e){e&&(window.castMediaManager?window.castMediaManager.setMediaElement(e):window.castMediaManager=new cast.receiver.MediaManager(e))},handleMessage:function(e){var t;try{t=JSON.parse(e.data)}catch(n){t=e.data}this.emit(a.EventType.MESSAGE,{from:e.senderId,message:t})},sendMessage:function(e,t){var n;if("string"==typeof t)window.castMessageBus.send(e,t);else{var n=JSON.stringify(t);n&&window.castMessageBus.send(e,n)}},broadcastMessage:function(e){var t;if("string"==typeof e)window.castMessageBus.broadcast(e);else{var t=JSON.stringify(e);t&&window.castMessageBus.broadcast(t)}},handleSenderConnected:function(e){null!=e&&null!=e.senderId&&(e.id=e.senderId,this.emit(a.EventType.JOIN,e))},handleSenderDisconnected:function(e){null!=e&&null!=e.senderId&&(e.id=e.senderId,this.emit(a.EventType.DEPART,e))}};var d,c=e({mixins:[s],constructor:function(){function e(e,t,n){var s=new window.PalmServiceBridge;return s.onservicecallback=function(e){n(JSON.parse(e))},s.call(e,JSON.stringify(t||{})),s}function t(e){for(var t,n=e.split("&"),s={},a=0,i=n.length;i>a;a++)t=n[a].split("="),s[t[0]]=decodeURIComponent(t[1]);return s}if(d)return d;if(d=this,this.stopRequested=!1,this.ws=null,this.channels=[],window.PalmServiceBridge){var n,s="com.webos.service.secondscreen.gateway",a="luna://com.webos.service.secondscreen.gateway/app2app/createAppChannel",i="luna://com.palm.bus/signal/registerServerStatus";this.getAppChannelWebSocket=function(t){statusSubcription=e(i,{subscribe:!0,serviceName:s},function(s){s&&s.connected&&(n=e(a,{},function(e){e.socketUrl&&t(new WebSocket(e.socketUrl))}))})}}else{var o=!1;if(window.location.search){console.log("found params: ",window.location.search);var r=t(window.location.search.substr(1));r.webOSAppChannelSocketUrl&&(console.log("found websocket URL: ",r.webOSAppChannelSocketUrl),o=!0,this.getAppChannelWebSocket=function(e){e(new WebSocket(r.webOSAppChannelSocketUrl))})}if(!o&&window.NetCastCreateAppChannel){var c="_webOSCreateAppChannelCallback";this.getAppChannelWebSocket=function(e){window[c]=function(t){delete window[c],t.socketUrl&&e(new WebSocket(t.socketUrl))},window.NetCastCreateAppChannel("{}",c,!1)}}}},getAppChannelWebSocket:function(){console.error("app channel socket not supported")},start:function(){this.stopRequested=!1;var e=this;!this.ws&&this.getAppChannelWebSocket(function(t){return e.stopRequested?(e.stop(),void 0):(e.ws=t,e.ws.onopen=function(t){console.log("websocket opened"),e.emit("ready",t)},e.ws.onerror=function(e){console.log("websocket error:",e)},e.ws.onmessage=function(t){try{var n=JSON.parse(t.data)}catch(s){return}switch(console.log("got message: "+JSON.stringify(n)),n.type){case"p2p":e._handleP2PMessage(n);break;case"p2p.depart":e._handleP2PDepart(n);break;case"p2p.join":e._handleP2PJoin(n);break;case"p2p.join-request":e._handleP2PJoinRequest(n)}},e.ws.onclose=function(){e.ws=null},void 0)})},stop:function(){this.stopRequested=!0,this.ws&&this.ws.close(),this._destroy()},sendMessage:function(e,t){var n={type:"p2p",to:e,payload:t};this._send(n)},broadcastMessage:function(e){var t={type:"p2p",payload:e};this._send(t)},_send:function(e){this.ws&&e&&(console.log("sending message: ",e),this.ws.send(JSON.stringify(e)))},_destroy:function(){this.ws&&(this.ws=null)},_handleP2PMessage:function(e){var t=e.payload;t&&(console.log("processing message payload "+JSON.stringify(t)),this.emit("message",{from:e.from,message:e.payload}))},_handleP2PJoinRequest:function(e){var t=e.payload;t&&this._send({type:"p2p.join-response",payload:{allowJoin:!0,requestId:t.requestId}})},_handleP2PJoin:function(e){var t=e.client;t&&(console.log("processing client join "+JSON.stringify(t)),this.emit(a.EventType.JOIN,t))},_handleP2PDepart:function(e){var t=e.from;t&&(console.log("processing client departure "+t),this.emit(a.EventType.DEPART,{id:t}))}});return{ConnectManager:a,WebOSAppChannels:c}}();